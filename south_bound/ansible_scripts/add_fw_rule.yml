- name: Configure iptables rule on FW
  hosts: "{{host}}"
  become: true
  vars:
    log_prefix: "IPTABLES-DROPPED: "    
  tasks:
    - name: Add iptables rule for FORWARD chain
      iptables:
        chain: FORWARD
        table: filter
        source: "{{ src_ip }}"
        destination: "{{ dest_ip }}"
        protocol: "{{ protocol }}"
        source_port: "{{ src_port }}"
        destination_port: "{{ dest_port }}"
        ctstate: "RELATED,ESTABLISHED"
        limit: "{{ threshold }}/second"
        jump: "{{ policy_action }}"
        insert: 1
        state: present
      when: protocol != "icmp"

    - name: Add iptables rule for ICMP in FORWARD chain
      iptables:
        chain: FORWARD
        table: filter
        source: "{{ src_ip }}"
        destination: "{{ dest_ip }}"
        ctstate: "RELATED,ESTABLISHED"
        protocol: icmp
        limit: "{{ threshold }}/second"
        jump: ACCEPT
        insert: 1
        state: present
      when: protocol == "icmp"


    - name: Add iptables rule to log dropped packets
      iptables:
        chain: FORWARD
        table: filter
        source: "{{ src_ip }}"
        destination: "{{ dest_ip }}"
        protocol: "{{ protocol }}"
        source_port: "{{ src_port }}"
        destination_port: "{{ dest_port }}"
        jump: "LOG"
        log_prefix: "{{ log_prefix }}"
        log_level: warning
        insert: 2
        state: present
      when: protocol != "icmp"

    - name: Add iptables rule to log dropped packets
      iptables:
        chain: FORWARD
        table: filter
        source: "{{ src_ip }}"
        destination: "{{ dest_ip }}"
        protocol: icmp
        jump: "LOG"
        log_prefix: "{{ log_prefix }}"
        log_level: warning
        insert: 2
        state: present
      when: protocol == "icmp"

    - name: Add iptables rule for drop exceeded FORWARD chain
      iptables:
        chain: FORWARD
        table: filter
        source: "{{ src_ip }}"
        destination: "{{ dest_ip }}"
        protocol: "{{ protocol }}"
        source_port: "{{ src_port }}"
        destination_port: "{{ dest_port }}"
        jump: DROP
        insert: 3
        state: present
      when: protocol != "icmp"

    - name: Add iptables rule for drop exceeded ICMP in FORWARD chain
      iptables:
        chain: FORWARD
        table: filter
        source: "{{ src_ip }}"
        destination: "{{ dest_ip }}"
        protocol: icmp
        jump: DROP
        insert: 3
        state: present
      when: protocol == "icmp"
